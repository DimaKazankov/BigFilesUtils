name: Benchmark Report

permissions:
  contents: write

on:
  push:
    branches:
      - "*"
    paths-ignore:
      - 'README.md'
      - 'docs/**'
  workflow_dispatch:  # Allow manual triggering of the workflow

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.0

      # Cache for .NET packages
      - name: Cache .NET packages
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # Setup .NET environment
      - name: Setup .NET
        uses: actions/setup-dotnet@v4.0.1
        with:
          dotnet-version: '8.0.402'

      # Restore .NET dependencies
      - name: Restore .NET dependencies
        run: dotnet restore

      # Build the project
      - name: Build the project
        run: dotnet build -c Release --no-restore

      # Run Tests
      - name: Run Tests
        run: dotnet test --no-build --verbosity normal -c Release

      # Publish the project
      - name: Publish
        run: dotnet publish -c Release --verbosity normal -o ./publish/

      # Run Benchmarks
      - name: Run Benchmarks
        run: dotnet "./publish/BigFilesUtils.dll" --benchmark

      # Clean docs directory
      - name: Clean docs directory
        run: |
          rm -rf docs/*
          mkdir -p docs/

      # Move benchmark results
      - name: Move benchmark results
        run: |
          mv BenchmarkDotNet.Artifacts/results/*-report-github.md docs/ || echo "No GitHub markdown report found!"
          mv BenchmarkDotNet.Artifacts/results/*.png docs/ || echo "No PNG files found!"
          mv BenchmarkDotNet.Artifacts/results/*.csv docs/ || echo "No CSV report found!"
          mv BenchmarkDotNet.Artifacts/results/*.html docs/ || echo "No HTML report found!"

      # Update README.md with benchmark results
      - name: Update README.md
        run: |
          # Remove existing benchmark results from README.md
          sed -i '/<!-- FILE_GENERATION_RESULTS_START -->/,/<!-- FILE_GENERATION_RESULTS_END -->/d' README.md
          sed -i '/<!-- FILE_SORTING_RESULTS_START -->/,/<!-- FILE_SORTING_RESULTS_END -->/d' README.md
          
          # Add new benchmark results to README.md
          echo '<!-- FILE_GENERATION_RESULTS_START -->' >> README.md
          echo '### File Generation Benchmarks' >> README.md
          echo '' >> README.md
          cat docs/*FileGeneratorBenchmark-report-github.md >> README.md
          echo '' >> README.md
          echo '<!-- FILE_GENERATION_RESULTS_END -->' >> README.md
          
          echo '<!-- FILE_SORTING_RESULTS_START -->' >> README.md
          echo '### File Sorting Benchmarks' >> README.md
          echo '' >> README.md
          cat docs/*FileSorterBenchmark-report-github.md >> README.md
          echo '' >> README.md
          echo '<!-- FILE_SORTING_RESULTS_END -->' >> README.md
          
          # Add images
          for img in docs/*.png; do
            echo "![Benchmark Chart]($img)" >> README.md
            echo '' >> README.md
          done

      # Commit and push changes
      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/*
          git add README.md
          git commit -m "Update benchmark results in README"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}